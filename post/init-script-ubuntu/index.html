<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>ubuntu初始化脚本 - YY小站</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="info@yanyong.cc"><meta name=description content="ubuntu初始化脚本 已在20.04和22.04验证通过，脚本已脱敏 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.127.0 with theme even"><link rel=canonical href=https://yanyong.cc/post/init-script-ubuntu/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://testingcf.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:url" content="https://yanyong.cc/post/init-script-ubuntu/"><meta property="og:site_name" content="YY小站"><meta property="og:title" content="ubuntu初始化脚本"><meta property="og:description" content="ubuntu初始化脚本 已在20.04和22.04验证通过，脚本已脱敏 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-01-10T17:14:23+08:00"><meta property="article:modified_time" content="2024-01-10T17:14:23+08:00"><meta property="article:tag" content="Ubuntu"><meta property="article:tag" content="Shell"><meta itemprop=name content="ubuntu初始化脚本"><meta itemprop=description content="ubuntu初始化脚本 已在20.04和22.04验证通过，脚本已脱敏 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36"><meta itemprop=datePublished content="2024-01-10T17:14:23+08:00"><meta itemprop=dateModified content="2024-01-10T17:14:23+08:00"><meta itemprop=wordCount content="2531"><meta itemprop=keywords content="Ubuntu,Shell"><meta name=twitter:card content="summary"><meta name=twitter:title content="ubuntu初始化脚本"><meta name=twitter:description content="ubuntu初始化脚本 已在20.04和22.04验证通过，脚本已脱敏 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>YY小站</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>首页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/categories/><li class=mobile-menu-item>分类</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>YY小站</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>首页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ubuntu初始化脚本</h1><div class=post-meta><span class=post-time>2024-01-10</span><div class=post-category><a href=/categories/linux/>Linux </a><a href=/categories/ubuntu/>Ubuntu</a></div><span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#ubuntu初始化脚本>ubuntu初始化脚本</a></li></ul></nav></div></div><div class=post-content><h1 id=ubuntu初始化脚本>ubuntu初始化脚本</h1><p>已在20.04和22.04验证通过，脚本已脱敏</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin  <span class=c1>#设置PATH环境变量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#为了兼容dash，测试语句建议使用[ expression ]，不要使用[[ expression ]]</span>
</span></span><span class=line><span class=cl><span class=c1>#为了兼容dash，[ expression ]中建议使用=，不要使用==</span>
</span></span><span class=line><span class=cl><span class=c1>#dash，函数名不支持小横线-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#彩色打印[yes]、[no]、[warning]</span>
</span></span><span class=line><span class=cl><span class=c1>#兼容bash和dash，dash的echo不支持-e，echo &#34;\e[32m  [yes]\e[0m&#34;即可</span>
</span></span><span class=line><span class=cl>echo_yes<span class=o>()</span> <span class=o>{</span> <span class=nb>echo</span> -n <span class=s2>&#34;    END: </span><span class=nv>$comment</span><span class=s2> &#34;</span><span class=p>;</span> bash -c <span class=s1>&#39;echo -e &#34;\e[32m  [yes]\e[0m&#34;&#39;</span><span class=p>;</span> <span class=o>}</span>  <span class=c1>#绿色</span>
</span></span><span class=line><span class=cl>echo_no<span class=o>()</span> <span class=o>{</span> <span class=nb>echo</span> -n <span class=s2>&#34;    END: </span><span class=nv>$comment</span><span class=s2> &#34;</span><span class=p>;</span> bash -c <span class=s1>&#39;echo -e &#34;\e[31m  [no]\e[0m&#34;&#39;</span><span class=p>;</span> <span class=o>}</span>  <span class=c1>#红色</span>
</span></span><span class=line><span class=cl>echo_warning<span class=o>()</span> <span class=o>{</span> <span class=nb>echo</span> -n <span class=s2>&#34;    END: </span><span class=nv>$comment</span><span class=s2> &lt;</span><span class=nv>$note</span><span class=s2>&gt;&#34;</span><span class=p>;</span> bash -c <span class=s1>&#39;echo -e &#34;\e[33m  [warning]\e[0m&#34;&#39;</span><span class=p>;</span> <span class=o>}</span>  <span class=c1>#黄色</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#显示脚本用法</span>
</span></span><span class=line><span class=cl>usage<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Usage: `basename </span><span class=nv>$0</span><span class=s2>` [-h] [-n hostname] [-p port] [-t timezone] [-c ntp] [-r]
</span></span></span><span class=line><span class=cl><span class=s2>说明：脚本只验证了ubuntu20.04和22.04，其它版本也许能用但不保证！
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Options:
</span></span></span><span class=line><span class=cl><span class=s2>    -h             : 显示帮助
</span></span></span><span class=line><span class=cl><span class=s2>    -n hostname    : 设置主机名
</span></span></span><span class=line><span class=cl><span class=s2>    -p port        : 设置ssh端口, 默认2208
</span></span></span><span class=line><span class=cl><span class=s2>    -t timezone    : 设置时区, 默认Asia/Shanghai(查看所有可用时区timedatectl list-timezones)
</span></span></span><span class=line><span class=cl><span class=s2>    -c ntp         : 设置同步的ntp服务器, 默认172.27.246.211
</span></span></span><span class=line><span class=cl><span class=s2>    -r             : 卸载青藤云
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#获取传入参数</span>
</span></span><span class=line><span class=cl>get_arguments<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>getopts</span> hn:p:t:c:r opt
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$opt</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>            h<span class=o>)</span> usage <span class=o>&amp;&amp;</span> <span class=nb>exit</span> 0<span class=p>;;</span>
</span></span><span class=line><span class=cl>            n<span class=o>)</span> <span class=nv>set_hostname</span><span class=o>=</span><span class=si>${</span><span class=nv>OPTARG</span><span class=si>}</span><span class=p>;;</span>
</span></span><span class=line><span class=cl>            p<span class=o>)</span> <span class=nv>set_port</span><span class=o>=</span><span class=si>${</span><span class=nv>OPTARG</span><span class=si>}</span><span class=p>;;</span>
</span></span><span class=line><span class=cl>            t<span class=o>)</span> <span class=nv>set_tz</span><span class=o>=</span><span class=si>${</span><span class=nv>OPTARG</span><span class=si>}</span><span class=p>;;</span>
</span></span><span class=line><span class=cl>            c<span class=o>)</span> <span class=nv>set_ntp</span><span class=o>=</span><span class=si>${</span><span class=nv>OPTARG</span><span class=si>}</span><span class=p>;;</span>
</span></span><span class=line><span class=cl>            r<span class=o>)</span> remove_qingtengyun<span class=p>;;</span>
</span></span><span class=line><span class=cl>            *<span class=o>)</span> usage <span class=o>&amp;&amp;</span> <span class=nb>exit</span> 1<span class=p>;;</span>
</span></span><span class=line><span class=cl>        <span class=k>esac</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>check_ip<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;检测是否已配置IP和DNS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> curl -s http://ip.example.com<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span>  <span class=c1>#换行</span>
</span></span><span class=line><span class=cl>        echo_yes
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        echo_no
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#用$USER变量检测不准确</span>
</span></span><span class=line><span class=cl><span class=c1>#######################################################</span>
</span></span><span class=line><span class=cl><span class=c1>#    $ whoami; echo $USER                             #</span>
</span></span><span class=line><span class=cl><span class=c1>#    user1                                            #</span>
</span></span><span class=line><span class=cl><span class=c1>#    user1                                            #</span>
</span></span><span class=line><span class=cl><span class=c1>#    $ su root                                        #</span>
</span></span><span class=line><span class=cl><span class=c1>#    Password:                                        #</span>
</span></span><span class=line><span class=cl><span class=c1>#    # whoami; echo $USER                             #</span>
</span></span><span class=line><span class=cl><span class=c1>#    root                                             #</span>
</span></span><span class=line><span class=cl><span class=c1>#    user1                                            #</span>
</span></span><span class=line><span class=cl><span class=c1>#######################################################</span>
</span></span><span class=line><span class=cl>check_notRoot<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;检测是否非root执行脚本，sudo用户做免密需要获取用户名&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;root&#34;</span> <span class=o>=</span> <span class=sb>`</span>whoami<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        echo_no
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        echo_yes
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_sudoNopasswd<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;设置sudo免密&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>   ALL=(ALL:ALL) NOPASSWD:ALL&#34;</span> <span class=p>|</span> sudo tee /etc/sudoers.d/<span class=nv>$USER</span>
</span></span><span class=line><span class=cl>    echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_hostname<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置主机名&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$set_hostname</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>  <span class=c1>#如果传入hostname参数</span>
</span></span><span class=line><span class=cl>        sudo hostnamectl set-hostname <span class=nv>$set_hostname</span>
</span></span><span class=line><span class=cl>        echo_yes
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nv>note</span><span class=o>=</span><span class=s2>&#34;未设置&#34;</span> <span class=o>&amp;&amp;</span> echo_warning
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>zabbixAgent2004<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>#文件名</span>
</span></span><span class=line><span class=cl>    <span class=nv>zabbix_agent_file</span><span class=o>=</span>zabbix_agent-6.0.33-linux-3.0-amd64-static.tar.gz
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#下载文件</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> ! -f <span class=si>${</span><span class=nv>zabbix_agent_file</span><span class=si>}</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        wget http://172.27.244.250/download/<span class=si>${</span><span class=nv>zabbix_agent_file</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#创建zabbix用户</span>
</span></span><span class=line><span class=cl>    sudo useradd -r -M -s /usr/sbin/nologin zabbix
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#安装zabbix agent</span>
</span></span><span class=line><span class=cl>    sudo mkdir /usr/local/zabbix <span class=o>&amp;&amp;</span> sudo chown zabbix:zabbix /usr/local/zabbix
</span></span><span class=line><span class=cl>    sudo tar zxf <span class=si>${</span><span class=nv>zabbix_agent_file</span><span class=si>}</span> -C /usr/local/zabbix
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#配置</span>
</span></span><span class=line><span class=cl>    sudo sed -ri <span class=s1>&#39;s/^(Server|ServerActive)=.*$/\1=zabbixproxy.example.com/&#39;</span> /usr/local/zabbix/conf/zabbix_agentd.conf
</span></span><span class=line><span class=cl>    <span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>hostname -I <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span> <span class=o>&amp;&amp;</span> sudo sed -i <span class=s2>&#34;s/^Hostname=.*</span>$<span class=s2>/Hostname=</span><span class=nv>$ip</span><span class=s2>/&#34;</span> /usr/local/zabbix/conf/zabbix_agentd.conf
</span></span><span class=line><span class=cl>    sudo sed -i <span class=s1>&#39;s/^# Timeout=3/Timeout=20/&#39;</span> /usr/local/zabbix/conf/zabbix_agentd.conf
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#添加自定义服务</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;添加自定义服务/etc/systemd/system/zabbix-agent.service&#34;</span>
</span></span><span class=line><span class=cl>    sudo tee /etc/systemd/system/zabbix-agent.service <span class=s>&lt;&lt;- EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Zabbix Agent
</span></span></span><span class=line><span class=cl><span class=s>After=syslog.target
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>PIDFile=/tmp/zabbix_agentd.pid
</span></span></span><span class=line><span class=cl><span class=s>KillMode=control-group
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/zabbix/sbin/zabbix_agentd -c /usr/local/zabbix/conf/zabbix_agentd.conf
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/bin/sh -c &#39;[ -n &#34;\$1&#34; ] &amp;&amp; kill -s TERM &#34;\$1&#34;&#39; -- &#34;\$MAINPID&#34;
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>User=zabbix
</span></span></span><span class=line><span class=cl><span class=s>Group=zabbix
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>    sudo systemctl restart zabbix-agent
</span></span><span class=line><span class=cl>    sudo systemctl <span class=nb>enable</span> zabbix-agent
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>zabbixAgent2204<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>libmodbus_deb</span><span class=o>=</span>libmodbus5_3.1.6-2_amd64.deb
</span></span><span class=line><span class=cl>    <span class=nv>zabbix_agent_deb</span><span class=o>=</span>zabbix-agent_6.0.33-2+ubuntu22.04_amd64.deb
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>[</span> -f <span class=si>${</span><span class=nv>libmodbus_deb</span><span class=si>}</span> <span class=o>]</span> <span class=o>||</span> wget http://172.27.244.250/download/<span class=si>${</span><span class=nv>libmodbus_deb</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> -f <span class=si>${</span><span class=nv>zabbix_agent_deb</span><span class=si>}</span> <span class=o>]</span> <span class=o>||</span> wget http://172.27.244.250/download/<span class=si>${</span><span class=nv>zabbix_agent_deb</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    sudo dpkg -i <span class=si>${</span><span class=nv>libmodbus_deb</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    sudo dpkg -i <span class=si>${</span><span class=nv>zabbix_agent_deb</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>conf</span><span class=o>=</span>/etc/zabbix/zabbix_agentd.conf
</span></span><span class=line><span class=cl>    sudo sed -ri <span class=s1>&#39;s/^(Server|ServerActive)=.*$/\1=zabbixproxy.example.com/&#39;</span> <span class=nv>$conf</span>
</span></span><span class=line><span class=cl>    <span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>hostname -I <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span> <span class=o>&amp;&amp;</span> sudo sed -i <span class=s2>&#34;s/^Hostname=.*</span>$<span class=s2>/Hostname=</span><span class=nv>$ip</span><span class=s2>/&#34;</span> <span class=nv>$conf</span>
</span></span><span class=line><span class=cl>    sudo sed -i <span class=s1>&#39;s/^# Timeout=3/Timeout=20/&#39;</span> <span class=nv>$conf</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    sudo systemctl restart zabbix-agent
</span></span><span class=line><span class=cl>    sudo systemctl <span class=nb>enable</span> zabbix-agent
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_zabbixAgent<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置zabbix-agent，仅ubuntu20.04和22.04&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#检测是否已安装，简单判断不严谨</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f /usr/local/zabbix/sbin/zabbix_agentd <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> -f /usr/sbin/zabbix_agentd <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;再次配置zabbix_agentd.conf的Hostname，解决克隆已初始化过的虚拟机时Hostname未更新问题&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span>lsb_release -rs<span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;22.04&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>hostname -I <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span> <span class=o>&amp;&amp;</span> sudo sed -i <span class=s2>&#34;s/^Hostname=.*</span>$<span class=s2>/Hostname=</span><span class=nv>$ip</span><span class=s2>/&#34;</span> /etc/zabbix/zabbix_agentd.conf
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=o>[</span> <span class=k>$(</span>lsb_release -rs<span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;20.04&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>ip</span><span class=o>=</span><span class=k>$(</span>hostname -I <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span> <span class=o>&amp;&amp;</span> sudo sed -i <span class=s2>&#34;s/^Hostname=.*</span>$<span class=s2>/Hostname=</span><span class=nv>$ip</span><span class=s2>/&#34;</span> /usr/local/zabbix/conf/zabbix_agentd.conf
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>note</span><span class=o>=</span><span class=s2>&#34;已安装，无需重复安装&#34;</span> <span class=o>&amp;&amp;</span> echo_warning
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=c1>#检查ubuntu版本</span>
</span></span><span class=line><span class=cl>        <span class=nv>os</span><span class=o>=</span><span class=k>$(</span>. /etc/os-release <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$VERSION_ID</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>#安装</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=nv>$os</span> <span class=o>=</span> <span class=s2>&#34;22.04&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            zabbixAgent2204
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=o>[</span> <span class=nv>$os</span> <span class=o>=</span> <span class=s2>&#34;20.04&#34;</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>            zabbixAgent2004
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nv>note</span><span class=o>=</span><span class=s2>&#34;非ubuntu20.04或22.04，跳过安装&#34;</span> <span class=o>&amp;&amp;</span> echo_warning
</span></span><span class=line><span class=cl>            <span class=k>return</span>  <span class=c1>#退出函数</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>#安装完了再检测一次进程</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ps -ef <span class=p>|</span> grep -q <span class=s1>&#39;zabbix_agent[d]&#39;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            echo_yes
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            echo_no
</span></span><span class=line><span class=cl>            <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_timezone_ntp<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置时区及时间同步，时区默认Asia/Shanghai，NTP默认172.27.246.211&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#timezone</span>
</span></span><span class=line><span class=cl>    <span class=nv>set_tz</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>set_tz</span><span class=k>:-</span><span class=nv>Asia</span><span class=p>/Shanghai</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1>#不传时区参数的话，默认设置Asia/Shanghai时区</span>
</span></span><span class=line><span class=cl>    sudo timedatectl set-timezone <span class=nv>$set_tz</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#ntp</span>
</span></span><span class=line><span class=cl>    <span class=nv>set_ntp</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>set_ntp</span><span class=k>:-</span><span class=nv>172</span><span class=p>.27.246.211</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1>#不传ntp服务器参数的话，默认172.27.246.211</span>
</span></span><span class=line><span class=cl>    sudo sed -ri <span class=s1>&#39;s/^#?(NTP=).*$/\1&#39;</span><span class=s2>&#34;</span><span class=nv>$set_ntp</span><span class=s2>&#34;</span><span class=s1>&#39;/&#39;</span> /etc/systemd/timesyncd.conf  <span class=c1>#正则^#?表示不管NTP那一行是否有注释，直接替换</span>
</span></span><span class=line><span class=cl>    sudo systemctl restart systemd-timesyncd
</span></span><span class=line><span class=cl>    echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_openfile_process<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置文件打开数及进程数&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;* soft nofile 204800
</span></span></span><span class=line><span class=cl><span class=s1>* hard nofile 204800
</span></span></span><span class=line><span class=cl><span class=s1>* soft nproc 204800
</span></span></span><span class=line><span class=cl><span class=s1>* hard nproc 204800&#39;</span> <span class=p>|</span> sudo tee /etc/security/limits.d/nofile-noproc.conf
</span></span><span class=line><span class=cl>echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_sshPort<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置ssh端口，默认2208&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#设置端口</span>
</span></span><span class=line><span class=cl>    <span class=nv>set_port</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>set_port</span><span class=k>:-</span><span class=nv>2208</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1>#不传ssh端口参数的话，默认设置2208</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#检测当前ssh端口</span>
</span></span><span class=line><span class=cl>    <span class=nv>config_port</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/^Port/{print $2}&#39;</span> /etc/ssh/sshd_config<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>ssh_port</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>config_port</span><span class=k>:-</span><span class=nv>22</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1>#如果config_port为空则是22端口</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#如果设置端口与当前端口不一致，才执行</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$set_port</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$ssh_port</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> grep -q <span class=s1>&#39;^Port [0-9]\+&#39;</span> /etc/ssh/sshd_config<span class=p>;</span> <span class=k>then</span>  <span class=c1>#如果配置文件有指定Port</span>
</span></span><span class=line><span class=cl>            sudo sed -ri <span class=s2>&#34;s/^Port [0-9]+</span>$<span class=s2>/Port </span><span class=nv>$set_port</span><span class=s2>/&#34;</span> /etc/ssh/sshd_config
</span></span><span class=line><span class=cl>        <span class=k>else</span>  <span class=c1>#否则没有指定Port，比如默认22端口的情况</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Port </span><span class=nv>$set_port</span><span class=s2>&#34;</span> <span class=p>|</span> sudo tee -a /etc/ssh/sshd_config
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        sudo systemctl reload ssh
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_sshKey<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置密钥&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> ! -d ~/.ssh <span class=o>]</span> <span class=o>&amp;&amp;</span> mkdir ~/.ssh
</span></span><span class=line><span class=cl>    chmod <span class=m>700</span> ~/.ssh
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>key1</span><span class=o>=</span><span class=s2>&#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDmxcc+pBN1C/y/dP0ktjsl6bVnMkLpfENdRJGHM/K4opoRKHrrBNI06ZdznP17n6vOkquHGzmLhp1/0xTgccbAlsogkJ2pvn5I70f4U/nNy root@ansible&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>key2</span><span class=o>=</span><span class=s2>&#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4aJi3XFOoLlTM9+4ZnJ1NvfkVyELN/2RW0JpVzYI020Uevzlt/tz3LLt9FFmwGyN4Cr+XZ29FsotrM3M9De3rwVVTZLzxg6vTMGXjxgwnT root@baoleiji&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! grep -q <span class=s2>&#34;</span><span class=nv>$key1</span><span class=s2>&#34;</span> ~/.ssh/authorized_keys<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$key1</span><span class=s2>&#34;</span> &gt;&gt; ~/.ssh/authorized_keys
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! grep -q <span class=s2>&#34;</span><span class=nv>$key2</span><span class=s2>&#34;</span> ~/.ssh/authorized_keys<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$key2</span><span class=s2>&#34;</span> &gt;&gt; ~/.ssh/authorized_keys
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    chmod <span class=m>600</span> ~/.ssh/authorized_keys
</span></span><span class=line><span class=cl>    echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_qingtengyun<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;配置青藤云&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#如果没有青藤云进程，则大概率没有安装，这里没有做很严谨的判断是否已经安装</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! ps -ef <span class=p>|</span> grep -q <span class=s1>&#39;titan_monito[r]&#39;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=c1>#安装</span>
</span></span><span class=line><span class=cl>        curl -sL <span class=s1>&#39;http://172.27.246.250/agent/download?k=1xyuuh0s00usnbx1g19i4tf6v8hef687w8hx1rj2&amp;group=1&amp;protocol=0&amp;root=true&amp;runAccount=root&amp;userAdd=false&#39;</span> <span class=p>|</span> sudo bash
</span></span><span class=line><span class=cl>        <span class=c1>#安装完再检查一次进程</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ps -ef <span class=p>|</span> grep -q <span class=s1>&#39;titan_monito[r]&#39;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            echo_yes
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            echo_no
</span></span><span class=line><span class=cl>            <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nv>note</span><span class=o>=</span><span class=s2>&#34;已安装，无需重复安装&#34;</span> <span class=o>&amp;&amp;</span> echo_warning
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>remove_qingtengyun<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;卸载青藤云&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! ps -ef <span class=p>|</span> grep -q <span class=s1>&#39;titan_monito[r]&#39;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>note</span><span class=o>=</span><span class=s2>&#34;未安装&#34;</span> <span class=o>&amp;&amp;</span> echo_warning
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>0</span>  <span class=c1>#退出脚本</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        sudo bash /titan/agent/install_agent.sh disclean
</span></span><span class=line><span class=cl>        echo_yes
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>0</span>  <span class=c1>#退出脚本</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set_ufw<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span><span class=o>=</span><span class=s2>&#34;关闭防火墙ufw&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;BEGIN: </span><span class=nv>$comment</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    sudo systemctl stop ufw
</span></span><span class=line><span class=cl>    sudo systemctl disable ufw
</span></span><span class=line><span class=cl>    echo_yes
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#主函数</span>
</span></span><span class=line><span class=cl>main<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    get_arguments <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#兼容bash和dash，dash不支持数组，不支持C风格的for循环</span>
</span></span><span class=line><span class=cl>    <span class=c1>#首先检查是否普通用户执行脚本</span>
</span></span><span class=line><span class=cl>    <span class=nv>func</span><span class=o>=</span><span class=s2>&#34;check_notRoot check_ip set_sudoNopasswd set_hostname set_timezone_ntp set_sshPort set_sshKey set_openfile_process set_zabbixAgent set_ufw set_qingtengyun&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>count</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$func</span> <span class=p>|</span> awk <span class=s1>&#39;{print NF}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>begin</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> f in <span class=nv>$func</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -n <span class=s2>&#34;</span><span class=nv>$begin</span><span class=s2>/</span><span class=nv>$count</span><span class=s2>) &#34;</span><span class=p>;</span> <span class=nv>$f</span>
</span></span><span class=line><span class=cl>        <span class=nv>begin</span><span class=o>=</span><span class=k>$((</span>begin+1<span class=k>))</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#脚本执行入口</span>
</span></span><span class=line><span class=cl>main <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>info@yanyong.cc</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2024-01-10</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/ubuntu/>ubuntu</a>
<a href=/tags/shell/>shell</a></div><nav class=post-nav><a class=prev href=/post/js-python-excel/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">wps(js宏)和python处理excel表格案例</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/fuck-lvm/><span class="next-text nav-default">Fuck lvm</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=onegit20/utterances issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:info@yanyong.cc class="iconfont icon-email" title=email></a><a href=https://stackoverflow.com/users/16859626/yanyong class="iconfont icon-stack-overflow" title=stack-overflow></a><a href=https://github.com/onegit20 class="iconfont icon-github" title=github></a></div><div class=copyright><div class=busuanzi-footer><span id=busuanzi_container_site_pv>site pv: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> </span><span class=division>|</span>
<span id=busuanzi_container_site_uv>site uv: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span></span></div><span class=copyright-year>&copy;
&nbsp;2025&nbsp;
<span>yanyong.cc</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://testingcf.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://testingcf.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://testingcf.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script><script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>